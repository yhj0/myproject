<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="board">
    <sql id="includeBoard">
        WHERE BRDDELETEFLAG='N'
         <if test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
              <foreach item="item" index="index" collection="searchTypeArr" separator=" OR " open="AND (" close=")">
                     ${item} LIKE CONCAT('%', #{searchKeyword},'%' )
              </foreach>
        </if>               
    </sql>

    <select id="selectNoticeCount2" resultType="Integer" parameterType="gu.common.SearchVO">
        SELECT COUNT(*)
          FROM TBL_NOTICE
         <include refid="includeBoard"/>
    </select> 
    
    <select id="selectNoticeCount" resultType="Integer" parameterType="gu.common.SearchVO">
        SELECT COUNT(*)
          FROM TBL_NOTICE
         <include refid="includeBoard"/>
    </select> 

    <select id="selectConsumerCount" resultType="Integer" parameterType="gu.common.SearchVO">
        SELECT COUNT(*)
          FROM TBL_BOARD
         <include refid="includeBoard"/>
    </select> 

    <select id="selectIssueCount" resultType="Integer" parameterType="gu.common.SearchVO">
        SELECT COUNT(*)
          FROM TBL_ISSUE
         <include refid="includeBoard"/>
    </select> 

    <select id="selectNoticeListMain" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
		SELECT A.* FROM(
			SELECT @ROWNUM := @ROWNUM + 1 AS NUM, BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
						 , BRDMEMO, REG_ID , REG_DTTM, CHG_ID, CHG_DTTM  
						 , NOTICE_FLAG1 , NOTICE_FLAG2 , NOTICE_FLAG3 ,NOTICE_FLAG4
			          FROM TBL_NOTICE TB,
			           (SELECT @ROWNUM := 0) R
			        WHERE BRDDELETEFLAG='N'
			         AND (NOTICE_FLAG1 = 'Y' OR NOTICE_FLAG2 = 'Y' OR NOTICE_FLAG3 = 'Y' OR NOTICE_FLAG4 = 'Y')
		        )A                
		     ORDER BY A.NUM DESC 
		     LIMIT 4
    </select>

    <select id="selectConsumerListMain" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
		SELECT A.* FROM(
			SELECT @ROWNUM := @ROWNUM + 1 AS NUM, BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
						, BRDMEMO, REG_ID , REG_DTTM, CHG_ID, CHG_DTTM
						, NOTICE_FLAG1 , NOTICE_FLAG2 , NOTICE_FLAG3 ,NOTICE_FLAG4
			          FROM TBL_BOARD TB,
			           (SELECT @ROWNUM := 0) R
			        WHERE BRDDELETEFLAG='N'
			        AND (NOTICE_FLAG1 = 'Y' OR NOTICE_FLAG2 = 'Y' OR NOTICE_FLAG3 = 'Y' OR NOTICE_FLAG4 = 'Y')
		        )A                
		     ORDER BY A.NUM DESC 
		     LIMIT 4
    </select>

    <select id="selectIssueListMain" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
		SELECT A.* FROM(
			SELECT @ROWNUM := @ROWNUM + 1 NUM, BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
							, BRDMEMO, REG_ID , REG_DTTM, CHG_ID, CHG_DTTM
							, NOTICE_FLAG1 , NOTICE_FLAG2 , NOTICE_FLAG3 ,NOTICE_FLAG4
			          FROM TBL_ISSUE TB,
			           (SELECT @ROWNUM := 0) R
			        WHERE BRDDELETEFLAG='N'
			        AND (NOTICE_FLAG1 = 'Y' OR NOTICE_FLAG2 = 'Y' OR NOTICE_FLAG3 = 'Y' OR NOTICE_FLAG4 = 'Y')
		        )A                
		     ORDER BY A.NUM DESC 
		     LIMIT 4
    </select>
 
     <select id="selectNoticeList" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
             , (SELECT COUNT(*) FROM TBL_BOARDFILE WHERE BRDNO=TB.BRDNO) FILECNT
             , (SELECT COUNT(*) FROM TBL_BOARDREPLY WHERE BRDNO=TB.BRDNO AND REDELETEFLAG='N') REPLYCNT
             , REG_ID , REG_DTTM, CHG_ID, CHG_DTTM
          FROM TBL_NOTICE TB
         <include refid="includeBoard"/>
         ORDER BY BRDNO DESC 
         LIMIT ${rowStart-1}, 10
    </select> 
    
    <select id="selectConsumerList" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
             , (SELECT COUNT(*) FROM TBL_BOARDFILE WHERE BRDNO=TB.BRDNO) FILECNT
             , (SELECT COUNT(*) FROM TBL_BOARDREPLY WHERE BRDNO=TB.BRDNO AND REDELETEFLAG='N') REPLYCNT
             , REG_ID , REG_DTTM, CHG_ID, CHG_DTTM
          FROM TBL_BOARD TB
         <include refid="includeBoard"/>
         ORDER BY BRDNO DESC 
         LIMIT ${rowStart-1}, 10
    </select> 

    <select id="selectIssueList" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE, BRDHIT
             , (SELECT COUNT(*) FROM TBL_BOARDFILE WHERE BRDNO=TB.BRDNO) FILECNT
             , (SELECT COUNT(*) FROM TBL_BOARDREPLY WHERE BRDNO=TB.BRDNO AND REDELETEFLAG='N') REPLYCNT
             , REG_ID , REG_DTTM, CHG_ID, CHG_DTTM
          FROM TBL_ISSUE TB
         <include refid="includeBoard"/>
         ORDER BY BRDNO DESC 
         LIMIT ${rowStart-1}, 10
    </select> 

    <insert id="insertNotice" parameterType="gu.board.BoardVO" >
        <selectKey resultType="String" keyProperty="brdno" order="BEFORE">
            SELECT IFNULL(MAX(BRDNO),0)+1 FROM TBL_NOTICE
        </selectKey>
    
        INSERT INTO TBL_NOTICE
        (
         BRDNO, 
         BRDTYPE,
         BRDTITLE, 
         BRDWRITER, 
         BRDMEMO, 
         BRDDATE, 
         BRDHIT, 
         BRDDELETEFLAG, 
         REG_ID, 
         REG_DTTM, 
         CHG_ID, 
         CHG_DTTM)
        VALUES 
        (
         #{brdno},
         'N',
         #{brdtitle}, 
         #{brdwriter}, 
         #{brdmemo}, 
         NOW(), 
         0, 
         'N',
        #{reg_id},
        NOW(),
        NULL,
        NULL
         )
    </insert>
    
    <insert id="insertBoard" parameterType="gu.board.BoardVO" >
        <selectKey resultType="String" keyProperty="brdno" order="BEFORE">
            SELECT IFNULL(MAX(BRDNO),0)+1 FROM TBL_BOARD
        </selectKey>
    
        INSERT INTO TBL_BOARD
        (
         BRDNO, 
         BRDTYPE,
         BRDTITLE, 
         BRDWRITER, 
         BRDMEMO, 
         BRDDATE, 
         BRDHIT, 
         BRDDELETEFLAG, 
         REG_ID, 
         REG_DTTM, 
         CHG_ID, 
         CHG_DTTM)
        VALUES 
        (
         #{brdno},
         'C',
         #{brdtitle}, 
         #{brdwriter}, 
         #{brdmemo}, 
         NOW(), 
         0, 
         'N',
        #{reg_id},
        NOW(),
        NULL,
        NULL
         )
    </insert>

    <insert id="insertIssue" parameterType="gu.board.BoardVO" >
        <selectKey resultType="String" keyProperty="brdno" order="BEFORE">
            SELECT IFNULL(MAX(BRDNO),0)+1 FROM TBL_ISSUE
        </selectKey>
    
        INSERT INTO TBL_ISSUE
        (
         BRDNO, 
         BRDTYPE,
         BRDTITLE, 
         BRDWRITER, 
         BRDMEMO, 
         BRDDATE, 
         BRDHIT, 
         BRDDELETEFLAG, 
         REG_ID, 
         REG_DTTM, 
         CHG_ID, 
         CHG_DTTM)
        VALUES 
        (
         #{brdno},
         'I',
         #{brdtitle}, 
         #{brdwriter}, 
         #{brdmemo}, 
         NOW(), 
         0, 
         'N',
        #{reg_id},
        NOW(),
        NULL,
        NULL
         )
    </insert>

    <update id="updateNotice" parameterType="gu.board.BoardVO">
        UPDATE TBL_NOTICE
           SET BRDTITLE=#{brdtitle}
             , BRDWRITER=#{brdwriter}
             , BRDMEMO=#{brdmemo} 
             , CHG_ID = #{reg_id}
             , CHG_DTTM = NOW()
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </update> 
  
    <update id="updateBoard" parameterType="gu.board.BoardVO">
        UPDATE TBL_BOARD
           SET BRDTITLE=#{brdtitle}
             , BRDWRITER=#{brdwriter}
             , BRDMEMO=#{brdmemo} 
             , CHG_ID = #{reg_id}
             , CHG_DTTM = NOW()
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </update> 

    <update id="updateIssue" parameterType="gu.board.BoardVO">
        UPDATE TBL_ISSUE
           SET BRDTITLE=#{brdtitle}
             , BRDWRITER=#{brdwriter}
             , BRDMEMO=#{brdmemo} 
             , CHG_ID = #{reg_id}
             , CHG_DTTM = NOW()
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </update> 

    <select id="selectNoticeOne" parameterType="String" resultType="gu.board.BoardVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_NOTICE
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </select> 
        
    <select id="selectBoardOne" parameterType="String" resultType="gu.board.BoardVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_BOARD
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </select> 

    <select id="selectIssueOne" parameterType="String" resultType="gu.board.BoardVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_ISSUE
         WHERE BRDDELETEFLAG='N'
           AND BRDNO=#{brdno}
    </select> 

    <update id="updateNoticeRead" parameterType="String">
        UPDATE TBL_NOTICE
           SET BRDHIT = BRDHIT + 1 
         WHERE BRDNO=#{brdno}
    </update> 

    <update id="updateBoardRead" parameterType="String">
        UPDATE TBL_BOARD
           SET BRDHIT = BRDHIT + 1 
         WHERE BRDNO=#{brdno}
    </update> 

    <update id="updateIssueRead" parameterType="String">
        UPDATE TBL_ISSUE
           SET BRDHIT = BRDHIT + 1 
         WHERE BRDNO=#{brdno}
    </update> 

    <delete id="deleteNoticeOne" parameterType="String">
        UPDATE TBL_NOTICE
           SET BRDDELETEFLAG='Y', 
               CHG_ID = #{reg_id},
               CHG_DTTM = NOW()
         WHERE BRDNO=#{brdno}
    </delete> 

    <delete id="deleteBoardOne" parameterType="String">
        UPDATE TBL_BOARD
           SET BRDDELETEFLAG='Y', 
               CHG_ID = #{reg_id},
               CHG_DTTM = NOW()
         WHERE BRDNO=#{brdno}
    </delete> 
    
    <delete id="deleteIssueOne" parameterType="String">
        UPDATE TBL_ISSUE
           SET BRDDELETEFLAG='Y', 
               CHG_ID = #{reg_id},
               CHG_DTTM = NOW()
         WHERE BRDNO=#{brdno}
    </delete> 

    <!-- =============================================================================== -->
    <select id="selectBoardFileList" resultType="gu.common.FileVO" parameterType="String">
        SELECT *
          FROM TBL_BOARDFILE
         WHERE BRDNO=#{brdno}
         ORDER BY FILENO DESC 
    </select> 

    <insert id="insertBoardFile" parameterType="gu.common.FileVO" >
        INSERT INTO TBL_BOARDFILE 
        (
        BRDNO, 
        FILENAME, 
        REALNAME, 
        FILESIZE,
        REG_ID,
        REG_DTTM,
        CHG_ID,
        CHG_DTTM
        )
        VALUES 
        (
        #{parentPK}, 
        #{filename}, 
        #{realname}, 
        #{filesize},
        #{reg_id},
  		NOW(),
  		NULL,
  		NULL        
        )
    </insert>
    
    <delete id="deleteBoardFile" parameterType="hashmap"> 
        DELETE 
          FROM TBL_BOARDFILE
         WHERE FILENO IN (
              <foreach item="item" index="index" collection="fileno" separator=",">
                     ${item}
              </foreach>  
        )             
    </delete> 

    <!-- =============================================================================== -->
    <select id="selectBoardReplyList" resultType="gu.board.BoardReplyVO">
        SELECT *
          FROM TBL_BOARDREPLY
         WHERE BRDNO=#{brdno} AND REDELETEFLAG='N'
         ORDER BY RENO
    </select>
        
    <insert id="insertBoardReply" parameterType="gu.board.BoardReplyVO" >
        <selectKey resultType="String" keyProperty="reno" order="BEFORE">
            SELECT IFNULL(MAX(RENO),0)+1 FROM TBL_BOARDREPLY
        </selectKey>
            
        INSERT INTO TBL_BOARDREPLY(
        BRDNO, 
        BRDTYPE,
        RENO, 
        REWRITER, 
        REDELETEFLAG, 
        REMEMO, 
        REG_ID,
        REG_DTTM,
        CHG_ID,
        CHG_DTTM
        )
        VALUES (
        #{brdno}, 
        'C',
        #{reno}, 
        #{rewriter}, 
        'N', 
        #{rememo}, 
        #{reg_id},
  		NOW(),
  		NULL,
  		NULL
        )
    </insert>

    <update id="deleteBoardReply" parameterType="String"> 
        UPDATE TBL_BOARDREPLY
           SET REDELETEFLAG='Y', 
               CHG_ID = #{reg_id},
               CHG_DTTM = NOW()
         WHERE RENO=#{reno}       
    </update> 

    <update id="updateBoardReply" parameterType="gu.board.BoardReplyVO">
        UPDATE TBL_BOARDREPLY
           SET REMEMO = #{rememo}, 
           	   CHG_ID = #{reg_id},
               CHG_DTTM =  NOW()
         WHERE RENO=#{reno}
    </update> 

    <select id="searchCount" resultType="Integer" parameterType="gu.common.SearchVO">
     	SELECT N.CNT+C.CNT+I.CNT FROM  ( 
	        (SELECT COUNT(*) CNT
	          FROM TBL_NOTICE
	         WHERE 1=1
	         	AND BRDDELETEFLAG='N'
	         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) )
	         )N,
	        (SELECT COUNT(*) CNT
	          FROM TBL_BOARD
	         WHERE 1=1
	         	AND BRDDELETEFLAG='N'
	         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) )
	         )C,
	        (SELECT COUNT(*) CNT
	          FROM TBL_ISSUE
	         WHERE 1=1
	         	AND BRDDELETEFLAG='N'
	         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) )
	         )I
	    )      	                       
    </select>      
    
    <select id="selectSearch" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, BRDHIT, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_NOTICE
         WHERE 1=1
         	AND BRDDELETEFLAG='N'
         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) )   
        UNION ALL  
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, BRDHIT, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_BOARD
         WHERE 1=1
         	AND BRDDELETEFLAG='N'
         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) ) 
 		UNION ALL     
        SELECT BRDNO, BRDTYPE, BRDTITLE, BRDWRITER, BRDMEMO, BRDHIT, DATE_FORMAT(BRDDATE,'%Y.%m.%d') BRDDATE ,REG_ID, REG_DTTM, CHG_ID, CHG_DTTM 
          FROM TBL_ISSUE
         WHERE 1=1
         	AND BRDDELETEFLAG='N'
         	AND (BRDTITLE LIKE CONCAT('%', #{searchKeyword},'%' ) OR BRDMEMO LIKE CONCAT('%', #{searchKeyword},'%' ) )  		     	        	          
    </select>  

    <select id="test1" resultType="gu.board.BoardVO" parameterType="gu.common.SearchVO">
        SELECT      
				  TB.BRDNO 
		  		, TB.BRDTYPE
				, TB.BRDTITLE
				, TB.BRDWRITER
				, TB.BRDMEMO
				, DATE_FORMAT(TB.BRDDATE,'%Y.%m.%d') BRDDATE 
				, TB.REG_ID
				, TB.REG_DTTM
				, TB.CHG_ID
				, TB.CHG_DTTM 
          	 	, (SELECT COUNT(*) FROM TBL_BOARDREPLY WHERE BRDNO=TB.BRDNO AND REDELETEFLAG='N') REPLYCNT 
          		, (SELECT COUNT(*) FROM TBL_LIKES WHERE BRDNO = TB.BRDNO)BRDLIKE
	          	, TF.FILENAME 
	          	, TF.FILESIZE
          FROM TBL_BOARD TB LEFT OUTER JOIN TBL_BOARDFILE TF 
          ON TB.BRDNO = TF.BRDNO
         WHERE 1=1 
	         AND TB.BRDDELETEFLAG='N'
         ORDER BY TB.BRDNO DESC 
           LIMIT  10                    
    </select>

    <select id="test2" resultType="gu.board.BoardVO">
    	<![CDATA[
        SELECT      
				  TB.BRDNO 
		  		, TB.BRDTYPE
				, TB.BRDTITLE
				, TB.BRDWRITER
				, TB.BRDMEMO
				, DATE_FORMAT(TB.BRDDATE,'%Y.%m.%d') BRDDATE 
				, TB.REG_ID
				, TB.REG_DTTM
				, TB.CHG_ID
				, TB.CHG_DTTM 
          	 	, (SELECT COUNT(*) FROM TBL_BOARDREPLY WHERE BRDNO=TB.BRDNO AND REDELETEFLAG='N') REPLYCNT
          		, (SELECT COUNT(*) FROM TBL_LIKES WHERE BRDNO = TB.BRDNO)BRDLIKE
          FROM TBL_BOARD TB
         WHERE 1=1 
	         AND TB.BRDDELETEFLAG='N'
         AND TB.BRDNO <= #{brdno}
         AND TB.BRDNO > #{brdno}-10
        ORDER BY TB.BRDNO DESC
        ]]>      
    </select>
</mapper>

